<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="admin-layout" id="admin-root" style="display:none;">

  <!-- ── Sidebar ──────────────────────────────────────────── -->
  <aside class="sidebar" role="navigation" aria-label="Menú del panel">
    <div class="sidebar-brand">
      <h2>TiendaOnline</h2>
      <p>Panel de Administración</p>
    </div>
    <ul class="sidebar-nav" role="list">
      <li><a href="#" class="active" data-tab="overview" aria-label="Resumen general">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Resumen
      </a></li>
      <li><a href="#" data-tab="products" aria-label="Gestionar productos">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
        Productos
      </a></li>
      <li><a href="#" data-tab="orders" aria-label="Gestionar pedidos">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Pedidos
      </a></li>
      <li><a href="#" data-tab="settings" aria-label="Configuración">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Configuración
      </a></li>
    </ul>
    <div style="padding:1rem 1.5rem; margin-top:auto; border-top:1px solid rgba(255,255,255,.1);">
      <button class="btn btn-danger btn-sm btn-full" id="btn-logout" aria-label="Cerrar sesión">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Cerrar sesión
      </button>
    </div>
  </aside>

  <!-- ── Contenido principal ──────────────────────────────── -->
  <div class="admin-main">

    <!-- ── TAB: Overview ──────────────────────────────────── -->
    <section class="tab-content active" id="tab-overview" aria-labelledby="overview-heading">
      <div class="admin-header">
        <h1 class="admin-title" id="overview-heading">Resumen general</h1>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="stats-grid" role="region" aria-label="Estadísticas">
        <div class="stat-card">
          <p class="stat-label">Total productos</p>
          <p class="stat-value" id="stat-total">—</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">En oferta</p>
          <p class="stat-value" id="stat-discount" style="color:var(--danger);">—</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Agotados</p>
          <p class="stat-value" id="stat-out" style="color:var(--warning);">—</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Total pedidos</p>
          <p class="stat-value" id="stat-orders" style="color:var(--accent);">—</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Pedidos pendientes</p>
          <p class="stat-value" id="stat-pending" style="color:var(--warning);">—</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Ingresos totales</p>
          <p class="stat-value" id="stat-revenue" style="color:var(--success);">—</p>
          <p class="stat-sub">de pedidos pagados</p>
        </div>
      </div>

      <!-- Últimos pedidos -->
      <div class="section-header">
        <h2 class="section-title" style="font-size:1.1rem;">Últimos pedidos</h2>
        <button class="btn btn-secondary btn-sm" data-tab="orders">Ver todos</button>
      </div>
      <div class="table-wrapper" id="recent-orders-table">
        <div class="loader"><div class="spinner" aria-hidden="true"></div><p>Cargando…</p></div>
      </div>
    </section>

    <!-- ── TAB: Productos ─────────────────────────────────── -->
    <section class="tab-content" id="tab-products" aria-labelledby="products-heading">
      <div class="admin-header">
        <h1 class="admin-title" id="products-heading">Productos</h1>
        <button class="btn btn-primary" id="btn-new-product" aria-label="Agregar nuevo producto">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuevo producto
        </button>
      </div>

      <div class="table-wrapper">
        <table aria-label="Lista de productos">
          <thead>
            <tr>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Precio</th>
              <th>Descuento</th>
              <th>Stock</th>
              <th>Vendidos</th>
              <th>Destacado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="products-table-body">
            <tr><td colspan="9" style="text-align:center; padding:2rem; color:var(--text-muted);">Cargando productos…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ── TAB: Pedidos ───────────────────────────────────── -->
    <section class="tab-content" id="tab-orders" aria-labelledby="orders-heading">
      <div class="admin-header">
        <h1 class="admin-title" id="orders-heading">Pedidos</h1>
        <div class="search-bar" style="max-width:260px;">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="search" id="orders-search" placeholder="Buscar pedido…" aria-label="Buscar en pedidos" />
        </div>
      </div>

      <!-- Filtro de estado -->
      <div class="filters" id="orders-filter" role="group" aria-label="Filtrar pedidos por estado" style="margin-bottom:1rem;">
        <button class="filter-btn active" data-status="all">Todos</button>
        <button class="filter-btn" data-status="Pendente">Pendentes</button>
        <button class="filter-btn" data-status="Pago">Pagos</button>
        <button class="filter-btn" data-status="Confirmado">Confirmados</button>
        <button class="filter-btn" data-status="Enviado">Enviados</button>
        <button class="filter-btn" data-status="Cancelado">Cancelados</button>
      </div>

      <div class="table-wrapper">
        <table aria-label="Lista de pedidos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Total</th>
              <th>Método</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="orders-table-body">
            <tr><td colspan="7" style="text-align:center; padding:2rem; color:var(--text-muted);">Cargando pedidos…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ── TAB: Settings ──────────────────────────────────── -->
    <section class="tab-content" id="tab-settings" aria-labelledby="settings-heading">
      <div class="admin-header">
        <h1 class="admin-title" id="settings-heading">Configuración</h1>
      </div>

      <div class="card" style="max-width:520px;">
        <div class="card-body">
          <h2 style="font-size:1rem; font-weight:700; margin-bottom:1.25rem;">Clave PIX</h2>
          <div class="form-group">
            <label class="form-label" for="setting-pix-key">Clave PIX / Datos de transferencia</label>
            <input class="form-control" type="text" id="setting-pix-key" placeholder="tu@email.com o clave aleatoria" />
          </div>
          <button class="btn btn-primary" id="btn-save-pix" aria-label="Guardar clave PIX">Guardar</button>
        </div>
      </div>

      <div class="card" style="max-width:520px; margin-top:1.25rem;">
        <div class="card-body">
          <h2 style="font-size:1rem; font-weight:700; margin-bottom:.5rem;">Mercado Pago — Webhook</h2>
          <p style="font-size:.85rem; color:var(--text-muted); margin-bottom:1rem;">
            Preparado para integración. Configura tu Access Token y endpoint en el backend.
          </p>
          <div class="form-group">
            <label class="form-label" for="setting-mp-token">Access Token (referencia)</label>
            <!-- El token real debe manejarse en el servidor, nunca en el cliente -->
            <input class="form-control" type="text" id="setting-mp-token" placeholder="APP_USR-..." disabled />
          </div>
          <p style="font-size:.78rem; color:var(--text-muted);">
            El Access Token debe configurarse en el entorno de servidor seguro.
          </p>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- ── Guard: pantalla de carga ──────────────────────────── -->
<div id="auth-guard" style="min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg);">
  <div class="loader">
    <div class="spinner" aria-hidden="true"></div>
    <p>Verificando sesión…</p>
  </div>
</div>

<!-- ── Modal Producto ─────────────────────────────────────── -->
<div class="modal-overlay hidden" id="product-modal" role="dialog" aria-modal="true" aria-labelledby="modal-product-title">
  <div class="modal" style="max-width:640px;">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-product-title">Nuevo producto</h2>
      <button class="modal-close" id="modal-product-close" aria-label="Cerrar modal">&times;</button>
    </div>
    <div class="modal-body">

      <input type="hidden" id="product-id-field" />

      <div class="form-row form-row-2">
        <div class="form-group">
          <label class="form-label" for="p-name">Nombre *</label>
          <input class="form-control" type="text" id="p-name" placeholder="Nombre del producto" required />
        </div>
        <div class="form-group">
          <label class="form-label" for="p-category">Categoría *</label>
          <input class="form-control" type="text" id="p-category" placeholder="Electrónica, Ropa…" required />
        </div>
      </div>

      <div class="form-row form-row-3">
        <div class="form-group">
          <label class="form-label" for="p-price">Precio *</label>
          <input class="form-control" type="number" id="p-price" placeholder="0.00" min="0" step="0.01" required />
        </div>
        <div class="form-group">
          <label class="form-label" for="p-discount">Descuento %</label>
          <input class="form-control" type="number" id="p-discount" placeholder="0" min="0" max="99" />
        </div>
        <div class="form-group">
          <label class="form-label" for="p-stock">Stock *</label>
          <input class="form-control" type="number" id="p-stock" placeholder="0" min="0" required />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="p-description">Descripción</label>
        <textarea class="form-control" id="p-description" rows="3" placeholder="Describe el producto…"></textarea>
      </div>

      <!-- Imagen -->
      <div class="form-group">
        <label class="form-label">Imagen del producto</label>
        <div
          class="upload-zone"
          id="upload-zone"
          role="button"
          tabindex="0"
          aria-label="Zona de carga de imagen. Haz clic o arrastra un archivo."
        >
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto .5rem;" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <p style="font-size:.875rem;">Arrastra una imagen o haz clic para seleccionar</p>
          <p style="font-size:.78rem; margin-top:.25rem; opacity:.7;">JPG, PNG, WEBP — máx. 5 MB</p>
          <input type="file" id="image-file" accept="image/*" style="display:none;" aria-label="Seleccionar imagen" />
        </div>
        <img id="image-preview" class="upload-preview" alt="Vista previa de la imagen seleccionada" />
        <!-- URL de imagen ya guardada -->
        <input class="form-control" type="url" id="p-image-url" placeholder="O pega aquí la URL de la imagen" style="margin-top:.5rem;" />
      </div>

      <label class="checkbox-label" style="margin-top:.25rem;">
        <input type="checkbox" id="p-featured" />
        Marcar como producto destacado
      </label>

      <!-- Barra de progreso de upload -->
      <div id="upload-progress-wrap" style="display:none; margin-top:1rem;">
        <p style="font-size:.82rem; color:var(--text-muted); margin-bottom:.35rem;" id="upload-progress-label">Subiendo imagen…</p>
        <div style="background:var(--border); border-radius:999px; height:6px; overflow:hidden;">
          <div id="upload-progress-bar" style="background:var(--accent); height:100%; width:0%; transition:width .3s ease;"></div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btn-cancel-product">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-product" aria-label="Guardar producto">Guardar producto</button>
    </div>
  </div>
</div>

<!-- ── Modal Detalle Pedido ────────────────────────────────── -->
<div class="modal-overlay hidden" id="order-modal" role="dialog" aria-modal="true" aria-labelledby="modal-order-title">
  <div class="modal" style="max-width:600px;">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-order-title">Detalle del pedido</h2>
      <button class="modal-close" id="modal-order-close" aria-label="Cerrar detalle de pedido">&times;</button>
    </div>
    <div class="modal-body" id="order-modal-body">
      <!-- contenido dinámico -->
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- ─────────────────────────────────────────────────────────
     SCRIPTS — Dashboard Admin
     ───────────────────────────────────────────────────────── -->
<script type="module">
// ── Imports Firebase ──────────────────────────────────────
import { db, auth, storage } from "./firebase-config.js";
import {
  collection,
  query,
  orderBy,
  onSnapshot,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  getDoc,
  runTransaction,
  serverTimestamp,
  limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  ref as storageRef,
  uploadBytesResumable,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// ── Estado global ─────────────────────────────────────────
let allProducts = [];
let allOrders   = [];
let editingId   = null;
let selectedImageFile = null;
let activeOrderFilter = "all";
let orderSearchQuery  = "";

// ── Auth guard ────────────────────────────────────────────
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  // Mostrar panel
  document.getElementById("auth-guard").style.display  = "none";
  document.getElementById("admin-root").style.display  = "grid";

  // Cargar datos
  loadProducts();
  loadOrders();
  loadSettings();
});

// ── Logout ────────────────────────────────────────────────
document.getElementById("btn-logout").addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch (err) {
    console.error("[Dashboard] Error al cerrar sesión:", err);
  }
});

// ── Navegación por tabs ───────────────────────────────────
function initTabs() {
  document.querySelectorAll("[data-tab]").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const tab = btn.dataset.tab;
      switchTab(tab);
    });
  });
}

function switchTab(tab) {
  // Ocultar todos los tabs y desactivar nav
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".sidebar-nav a").forEach(a => a.classList.remove("active"));

  // Activar tab seleccionado
  const tabEl = document.getElementById(`tab-${tab}`);
  if (tabEl) tabEl.classList.add("active");

  const navEl = document.querySelector(`.sidebar-nav a[data-tab="${tab}"]`);
  if (navEl) navEl.classList.add("active");
}

initTabs();

// ════════════════════════════════════════════════════════════
// PRODUCTOS
// ════════════════════════════════════════════════════════════

// ── Cargar productos en tiempo real ──────────────────────
function loadProducts() {
  const q = query(collection(db, "products"), orderBy("createdAt", "desc"));

  onSnapshot(q, snapshot => {
    allProducts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    renderProductsTable();
    updateStats();
  }, err => {
    console.error("[Dashboard] Error productos:", err);
    showToast("Error al cargar productos", "error");
  });
}

// ── Renderizar tabla de productos ─────────────────────────
function renderProductsTable() {
  const tbody = document.getElementById("products-table-body");

  if (allProducts.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:2rem; color:var(--text-muted);">No hay productos. Agrega el primero.</td></tr>`;
    return;
  }

  tbody.innerHTML = allProducts.map(p => {
    const finalPrice = p.discount > 0 ? (p.price * (1 - p.discount / 100)).toFixed(2) : p.price;
    const imgSrc     = p.image || "https://placehold.co/48x48?text=Producto";
    const stockClass = p.stock === 0 ? "color:var(--danger); font-weight:700;" : p.stock <= 5 ? "color:var(--warning); font-weight:700;" : "";

    return `
      <tr>
        <td>
          <img class="table-img" src="${imgSrc}" alt="${p.name}" onerror="this.src='https://placehold.co/48x48?text=Sin+imagen'" />
        </td>
        <td style="font-weight:600; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.name}</td>
        <td style="color:var(--text-muted);">${p.category || "—"}</td>
        <td style="font-weight:600;">$${Number(p.price).toLocaleString("es")}</td>
        <td>${p.discount > 0 ? `<span class="badge badge-discount">-${p.discount}%</span>` : "—"}</td>
        <td style="${stockClass}">${p.stock}</td>
        <td>${p.sold || 0}</td>
        <td>${p.featured ? '<span class="badge badge-featured">Sí</span>' : "—"}</td>
        <td>
          <div style="display:flex; gap:.4rem;">
            <button class="btn btn-secondary btn-sm" data-action="edit" data-id="${p.id}" aria-label="Editar ${p.name}">Editar</button>
            <button class="btn btn-danger    btn-sm" data-action="delete" data-id="${p.id}" aria-label="Eliminar ${p.name}">Eliminar</button>
          </div>
        </td>
      </tr>`;
  }).join("");

  // Eventos de tabla
  tbody.querySelectorAll("[data-action]").forEach(btn => {
    btn.addEventListener("click", () => {
      const { action, id } = btn.dataset;
      if (action === "edit")   openProductModal(id);
      if (action === "delete") deleteProduct(id);
    });
  });
}

// ── Abrir modal de producto (crear / editar) ───────────────
function openProductModal(id = null) {
  editingId = id;
  resetProductForm();

  const modal = document.getElementById("product-modal");
  const title = document.getElementById("modal-product-title");

  if (id) {
    const product = allProducts.find(p => p.id === id);
    if (!product) return;

    title.textContent = "Editar producto";
    document.getElementById("product-id-field").value = id;
    document.getElementById("p-name").value        = product.name        || "";
    document.getElementById("p-category").value    = product.category    || "";
    document.getElementById("p-price").value       = product.price       || 0;
    document.getElementById("p-discount").value    = product.discount    || 0;
    document.getElementById("p-stock").value       = product.stock       || 0;
    document.getElementById("p-description").value = product.description || "";
    document.getElementById("p-featured").checked  = product.featured    || false;
    document.getElementById("p-image-url").value   = product.image       || "";

    if (product.image) {
      const preview     = document.getElementById("image-preview");
      preview.src       = product.image;
      preview.style.display = "block";
    }
  } else {
    title.textContent = "Nuevo producto";
  }

  modal.classList.remove("hidden");
}

function resetProductForm() {
  selectedImageFile = null;
  ["product-id-field","p-name","p-category","p-price","p-discount","p-stock","p-description","p-image-url"].forEach(id => {
    document.getElementById(id).value = "";
  });
  document.getElementById("p-featured").checked  = false;
  document.getElementById("image-preview").style.display = "none";
  document.getElementById("upload-progress-wrap").style.display = "none";
  document.getElementById("upload-progress-bar").style.width    = "0%";
  document.getElementById("image-file").value = "";
}

// ── Cerrar modal ──────────────────────────────────────────
document.getElementById("modal-product-close").addEventListener("click",  () => document.getElementById("product-modal").classList.add("hidden"));
document.getElementById("btn-cancel-product").addEventListener("click",   () => document.getElementById("product-modal").classList.add("hidden"));
document.getElementById("btn-new-product").addEventListener("click",      () => openProductModal());

// ── Zona de upload de imagen ──────────────────────────────
const uploadZone  = document.getElementById("upload-zone");
const imageFileEl = document.getElementById("image-file");
const imgPreview  = document.getElementById("image-preview");

uploadZone.addEventListener("click",  () => imageFileEl.click());
uploadZone.addEventListener("keydown", e => { if (e.key === "Enter" || e.key === " ") imageFileEl.click(); });

uploadZone.addEventListener("dragover",  e => { e.preventDefault(); uploadZone.classList.add("dragover"); });
uploadZone.addEventListener("dragleave", ()  => uploadZone.classList.remove("dragover"));
uploadZone.addEventListener("drop", e => {
  e.preventDefault();
  uploadZone.classList.remove("dragover");
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith("image/")) handleImageSelection(file);
});

imageFileEl.addEventListener("change", () => {
  const file = imageFileEl.files[0];
  if (file) handleImageSelection(file);
});

function handleImageSelection(file) {
  if (file.size > 5 * 1024 * 1024) {
    showToast("La imagen debe ser menor a 5 MB", "error");
    return;
  }
  selectedImageFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    imgPreview.src           = e.target.result;
    imgPreview.style.display = "block";
  };
  reader.readAsDataURL(file);
}

// ── Subir imagen a Firebase Storage ──────────────────────
async function uploadImage(file) {
  const progressWrap  = document.getElementById("upload-progress-wrap");
  const progressBar   = document.getElementById("upload-progress-bar");
  const progressLabel = document.getElementById("upload-progress-label");

  progressWrap.style.display = "block";
  progressLabel.textContent  = "Subiendo imagen…";

  return new Promise((resolve, reject) => {
    const fileRef  = storageRef(storage, `products/${Date.now()}_${file.name}`);
    const task     = uploadBytesResumable(fileRef, file);

    task.on("state_changed",
      snapshot => {
        const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        progressBar.style.width    = pct + "%";
        progressLabel.textContent  = `Subiendo… ${pct}%`;
      },
      err => {
        console.error("[Dashboard] Error upload:", err);
        reject(err);
      },
      async () => {
        try {
          const url = await getDownloadURL(task.snapshot.ref);
          progressLabel.textContent = "¡Imagen subida correctamente!";
          resolve(url);
        } catch (err) {
          reject(err);
        }
      }
    );
  });
}

// ── Guardar producto (crear / actualizar) ──────────────────
document.getElementById("btn-save-product").addEventListener("click", async () => {
  const name        = document.getElementById("p-name").value.trim();
  const category    = document.getElementById("p-category").value.trim();
  const price       = parseFloat(document.getElementById("p-price").value);
  const discount    = parseInt(document.getElementById("p-discount").value) || 0;
  const stock       = parseInt(document.getElementById("p-stock").value);
  const description = document.getElementById("p-description").value.trim();
  const featured    = document.getElementById("p-featured").checked;
  let   imageUrl    = document.getElementById("p-image-url").value.trim();
  const saveBtn     = document.getElementById("btn-save-product");

  // Validaciones
  if (!name)            { showToast("El nombre es obligatorio", "error"); return; }
  if (!category)        { showToast("La categoría es obligatoria", "error"); return; }
  if (isNaN(price) || price < 0)  { showToast("Ingresa un precio válido", "error"); return; }
  if (isNaN(stock) || stock < 0)  { showToast("Ingresa un stock válido", "error"); return; }
  if (discount < 0 || discount > 99) { showToast("El descuento debe estar entre 0 y 99", "error"); return; }

  saveBtn.disabled    = true;
  saveBtn.textContent = "Guardando…";

  try {
    // Subir imagen si hay archivo nuevo
    if (selectedImageFile) {
      imageUrl = await uploadImage(selectedImageFile);
    }

    const productData = {
      name,
      category,
      price,
      discount,
      stock,
      description,
      featured,
      image: imageUrl
    };

    if (editingId) {
      // ── Actualizar existente ──────────────────────────
      await updateDoc(doc(db, "products", editingId), productData);
      showToast("Producto actualizado", "success");
    } else {
      // ── Crear nuevo ───────────────────────────────────
      productData.sold      = 0;
      productData.createdAt = serverTimestamp();
      await addDoc(collection(db, "products"), productData);
      showToast("Producto creado", "success");
    }

    document.getElementById("product-modal").classList.add("hidden");

  } catch (err) {
    console.error("[Dashboard] Error guardando producto:", err);
    showToast("Error al guardar el producto", "error");
  } finally {
    saveBtn.disabled    = false;
    saveBtn.textContent = "Guardar producto";
  }
});

// ── Eliminar producto ────────────────────────────────────
async function deleteProduct(id) {
  const product = allProducts.find(p => p.id === id);
  if (!confirm(`¿Eliminar "${product?.name}"? Esta acción no se puede deshacer.`)) return;

  try {
    await deleteDoc(doc(db, "products", id));
    showToast("Producto eliminado", "success");
  } catch (err) {
    console.error("[Dashboard] Error eliminando producto:", err);
    showToast("Error al eliminar el producto", "error");
  }
}

// ════════════════════════════════════════════════════════════
// PEDIDOS
// ════════════════════════════════════════════════════════════

// ── Cargar pedidos en tiempo real ────────────────────────
function loadOrders() {
  const q = query(collection(db, "pedidos"), orderBy("data", "desc"));

  onSnapshot(q, snapshot => {
    allOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    renderOrdersTable();
    renderRecentOrders();
    updateStats();
  }, err => {
    console.error("[Dashboard] Error pedidos:", err);
    showToast("Error al cargar pedidos", "error");
  });
}

// ── Filtros de pedidos ─────────────────────────────────────
document.querySelectorAll("#orders-filter .filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    activeOrderFilter = btn.dataset.status;
    document.querySelectorAll("#orders-filter .filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderOrdersTable();
  });
});

document.getElementById("orders-search").addEventListener("input", e => {
  orderSearchQuery = e.target.value.toLowerCase();
  renderOrdersTable();
});

// ── Renderizar tabla de pedidos ────────────────────────────
function renderOrdersTable() {
  const tbody = document.getElementById("orders-table-body");

  let orders = allOrders;

  if (activeOrderFilter !== "all") {
    orders = orders.filter(o => o.estado === activeOrderFilter);
  }

  if (orderSearchQuery) {
    orders = orders.filter(o =>
      o.id.toLowerCase().includes(orderSearchQuery) ||
      (o.cliente?.nome    || "").toLowerCase().includes(orderSearchQuery) ||
      (o.cliente?.telefone|| "").toLowerCase().includes(orderSearchQuery)
    );
  }

  if (orders.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:2rem; color:var(--text-muted);">No se encontraron pedidos.</td></tr>`;
    return;
  }

  tbody.innerHTML = orders.map(o => {
    const date = o.data?.toDate ? o.data.toDate().toLocaleDateString("es") : "—";
    return `
      <tr>
        <td style="font-family:var(--font-mono); font-size:.75rem; color:var(--text-muted);">${o.id.substring(0, 8)}…</td>
        <td>
          <div style="font-weight:600; font-size:.875rem;">${o.cliente?.nome || "—"}</div>
          <div style="font-size:.78rem; color:var(--text-muted);">${o.cliente?.telefone || ""}</div>
        </td>
        <td style="font-weight:700; color:var(--accent);">$${Number(o.total || 0).toLocaleString("es")}</td>
        <td>
          <span style="text-transform:capitalize; font-size:.82rem;">${o.metodo_pago || "—"}</span>
        </td>
        <td>
          <select
            class="status-select"
            data-order-id="${o.id}"
            data-current-status="${o.estado}"
            aria-label="Cambiar estado del pedido ${o.id}"
          >
            ${["Pendente","Pago","Confirmado","Enviado","Cancelado"].map(s =>
              `<option value="${s}" ${o.estado === s ? "selected" : ""}>${s}</option>`
            ).join("")}
          </select>
        </td>
        <td style="font-size:.82rem; color:var(--text-muted);">${date}</td>
        <td>
          <button class="btn btn-secondary btn-sm" data-action="view-order" data-id="${o.id}" aria-label="Ver detalles del pedido ${o.id}">Ver</button>
        </td>
      </tr>`;
  }).join("");

  // ── Eventos de cambio de estado ───────────────────────
  tbody.querySelectorAll(".status-select").forEach(select => {
    select.addEventListener("change", async () => {
      const orderId     = select.dataset.orderId;
      const oldStatus   = select.dataset.currentStatus;
      const newStatus   = select.value;
      await handleStatusChange(orderId, oldStatus, newStatus, select);
    });
  });

  // ── Ver detalle del pedido ────────────────────────────
  tbody.querySelectorAll("[data-action='view-order']").forEach(btn => {
    btn.addEventListener("click", () => openOrderModal(btn.dataset.id));
  });
}

// ── Renderizar últimos pedidos en Overview ─────────────────
function renderRecentOrders() {
  const container = document.getElementById("recent-orders-table");
  const recent    = allOrders.slice(0, 5);

  if (recent.length === 0) {
    container.innerHTML = `<p style="padding:1rem; color:var(--text-muted);">Sin pedidos aún.</p>`;
    return;
  }

  container.innerHTML = `
    <table aria-label="Últimos pedidos">
      <thead><tr>
        <th>Cliente</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Fecha</th>
      </tr></thead>
      <tbody>
        ${recent.map(o => {
          const date = o.data?.toDate ? o.data.toDate().toLocaleDateString("es") : "—";
          return `
            <tr>
              <td style="font-weight:600;">${o.cliente?.nome || "—"}</td>
              <td style="color:var(--accent); font-weight:700;">$${Number(o.total || 0).toLocaleString("es")}</td>
              <td><span class="badge badge-${(o.estado || "").toLowerCase()}">${o.estado || "—"}</span></td>
              <td style="color:var(--text-muted); font-size:.82rem;">${date}</td>
            </tr>`;
        }).join("")}
      </tbody>
    </table>`;
}

// ────────────────────────────────────────────────────────────
// LÓGICA DE CAMBIO DE ESTADO CON TRANSACCIÓN
// Cuando pasa a "Pago"     → descuenta stock, suma sold
// Cuando pasa a "Cancelado" → restaura stock
// ────────────────────────────────────────────────────────────
async function handleStatusChange(orderId, oldStatus, newStatus, selectEl) {
  if (oldStatus === newStatus) return;

  // Deshabilitar select durante la operación
  selectEl.disabled = true;

  try {
    // Obtener datos del pedido
    const orderSnap = await getDoc(doc(db, "pedidos", orderId));
    if (!orderSnap.exists()) throw new Error("Pedido no encontrado");

    const orderData = orderSnap.data();
    const productos  = orderData.productos || [];

    // ── Cambio a "Pago" → descontar stock ──────────────
    if (newStatus === "Pago" && oldStatus !== "Pago") {

      await runTransaction(db, async tx => {
        // Verificar todos los productos antes de modificar
        const productRefs  = productos.map(p => doc(db, "products", p.id));
        const productSnaps = await Promise.all(productRefs.map(r => tx.get(r)));

        for (let i = 0; i < productSnaps.length; i++) {
          const snap = productSnaps[i];
          if (!snap.exists()) continue;

          const currentStock = snap.data().stock || 0;
          const qty          = productos[i].quantidade;

          if (currentStock < qty) {
            throw new Error(`Stock insuficiente para "${productos[i].nome}". Disponible: ${currentStock}, Requerido: ${qty}`);
          }
        }

        // Aplicar cambios de stock y sold
        for (let i = 0; i < productSnaps.length; i++) {
          const snap = productSnaps[i];
          if (!snap.exists()) continue;

          const currentStock = snap.data().stock || 0;
          const currentSold  = snap.data().sold  || 0;
          const qty          = productos[i].quantidade;

          tx.update(productRefs[i], {
            stock: currentStock - qty,
            sold:  currentSold  + qty
          });
        }

        // Actualizar estado del pedido
        tx.update(doc(db, "pedidos", orderId), { estado: newStatus });
      });

      showToast("Pedido marcado como pagado. Stock actualizado.", "success");

    // ── Cambio a "Cancelado" → restaurar stock ──────────
    } else if (newStatus === "Cancelado" && oldStatus !== "Cancelado") {

      // Solo restaurar si venía de "Pago" (el stock ya fue descontado)
      if (oldStatus === "Pago") {
        await runTransaction(db, async tx => {
          const productRefs  = productos.map(p => doc(db, "products", p.id));
          const productSnaps = await Promise.all(productRefs.map(r => tx.get(r)));

          for (let i = 0; i < productSnaps.length; i++) {
            const snap = productSnaps[i];
            if (!snap.exists()) continue;

            const currentStock = snap.data().stock || 0;
            const currentSold  = snap.data().sold  || 0;
            const qty          = productos[i].quantidade;

            tx.update(productRefs[i], {
              stock: currentStock + qty,
              sold:  Math.max(0, currentSold - qty)
            });
          }

          tx.update(doc(db, "pedidos", orderId), { estado: newStatus });
        });

        showToast("Pedido cancelado. Stock restaurado.", "warning");

      } else {
        // Solo cambiar estado
        await updateDoc(doc(db, "pedidos", orderId), { estado: newStatus });
        showToast("Estado actualizado a Cancelado", "warning");
      }

    } else {
      // ── Cualquier otro cambio de estado ───────────────
      await updateDoc(doc(db, "pedidos", orderId), { estado: newStatus });
      showToast(`Estado actualizado a "${newStatus}"`, "success");
    }

    // Actualizar el data-attribute del select
    selectEl.dataset.currentStatus = newStatus;

  } catch (err) {
    console.error("[Dashboard] Error cambiando estado:", err);
    showToast(err.message || "Error al cambiar el estado", "error");
    // Revertir el select al estado anterior
    selectEl.value = oldStatus;
  } finally {
    selectEl.disabled = false;
  }
}

// ── Modal detalle de pedido ───────────────────────────────
function openOrderModal(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  if (!order) return;

  const date     = order.data?.toDate ? order.data.toDate().toLocaleString("es") : "—";
  const products = order.productos || [];

  document.getElementById("order-modal-body").innerHTML = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.25rem;">
      <div>
        <p style="font-size:.78rem; color:var(--text-muted); text-transform:uppercase; font-weight:600; margin-bottom:.25rem;">Cliente</p>
        <p style="font-weight:600;">${order.cliente?.nome || "—"}</p>
        <p style="font-size:.85rem;">${order.cliente?.telefone || ""}</p>
        <p style="font-size:.85rem; color:var(--text-muted); margin-top:.2rem;">${order.cliente?.endereco || ""}</p>
      </div>
      <div>
        <p style="font-size:.78rem; color:var(--text-muted); text-transform:uppercase; font-weight:600; margin-bottom:.25rem;">Pedido</p>
        <p style="font-family:var(--font-mono); font-size:.78rem; color:var(--text-muted);">${order.id}</p>
        <p style="font-size:.85rem; margin-top:.25rem;">Fecha: ${date}</p>
        <p style="font-size:.85rem;">Método: <strong>${order.metodo_pago || "—"}</strong></p>
      </div>
    </div>

    <h3 style="font-size:.9rem; font-weight:700; margin-bottom:.75rem; border-top:1px solid var(--border); padding-top:.75rem;">Productos del pedido</h3>
    ${products.map(p => `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:.5rem 0; border-bottom:1px solid var(--border); font-size:.875rem;">
        <div>
          <span style="font-weight:600;">${p.nome}</span>
          <span style="color:var(--text-muted);"> x${p.quantidade}</span>
        </div>
        <span style="font-weight:700; color:var(--accent);">$${(p.preco * p.quantidade).toLocaleString("es")}</span>
      </div>`).join("")}

    <div style="display:flex; justify-content:space-between; align-items:center; padding-top:1rem; font-size:1.1rem; font-weight:800;">
      <span>Total</span>
      <span style="color:var(--accent);">$${Number(order.total || 0).toLocaleString("es")}</span>
    </div>

    ${order.notas ? `
      <div style="margin-top:1rem; padding:.75rem; background:var(--bg); border-radius:var(--radius); font-size:.85rem;">
        <strong>Notas:</strong> ${order.notas}
      </div>` : ""}`;

  document.getElementById("order-modal").classList.remove("hidden");
}

document.getElementById("modal-order-close").addEventListener("click", () => {
  document.getElementById("order-modal").classList.add("hidden");
});

// Cerrar modales al clic fuera
document.querySelectorAll(".modal-overlay").forEach(overlay => {
  overlay.addEventListener("click", e => {
    if (e.target === overlay) overlay.classList.add("hidden");
  });
});

// ════════════════════════════════════════════════════════════
// ESTADÍSTICAS
// ════════════════════════════════════════════════════════════

function updateStats() {
  const total    = allProducts.length;
  const inOffer  = allProducts.filter(p => p.discount > 0).length;
  const outStock = allProducts.filter(p => p.stock === 0).length;
  const orders   = allOrders.length;
  const pending  = allOrders.filter(o => o.estado === "Pendente").length;
  const revenue  = allOrders
    .filter(o => o.estado === "Pago" || o.estado === "Confirmado" || o.estado === "Enviado")
    .reduce((acc, o) => acc + (o.total || 0), 0);

  document.getElementById("stat-total").textContent   = total;
  document.getElementById("stat-discount").textContent = inOffer;
  document.getElementById("stat-out").textContent     = outStock;
  document.getElementById("stat-orders").textContent  = orders;
  document.getElementById("stat-pending").textContent = pending;
  document.getElementById("stat-revenue").textContent = "$" + revenue.toLocaleString("es", { minimumFractionDigits: 2 });
}

// ════════════════════════════════════════════════════════════
// SETTINGS
// ════════════════════════════════════════════════════════════

async function loadSettings() {
  try {
    const snap = await getDoc(doc(db, "settings", "pix"));
    if (snap.exists()) {
      document.getElementById("setting-pix-key").value = snap.data().key || "";
    }
  } catch (err) {
    console.error("[Dashboard] Error cargando settings:", err);
  }
}

document.getElementById("btn-save-pix").addEventListener("click", async () => {
  const key    = document.getElementById("setting-pix-key").value.trim();
  const btn    = document.getElementById("btn-save-pix");
  btn.disabled = true;
  btn.textContent = "Guardando…";

  try {
    const settingsRef = doc(db, "settings", "pix");
    const snap        = await getDoc(settingsRef);

    if (snap.exists()) {
      await updateDoc(settingsRef, { key });
    } else {
      const { setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      await setDoc(settingsRef, { key });
    }

    showToast("Clave PIX guardada", "success");
  } catch (err) {
    console.error("[Dashboard] Error guardando PIX:", err);
    showToast("Error al guardar la clave PIX", "error");
  } finally {
    btn.disabled    = false;
    btn.textContent = "Guardar";
  }
});

// ── Toast ─────────────────────────────────────────────────
function showToast(message, type = "info") {
  const container = document.getElementById("toast-container");
  const toast     = document.createElement("div");
  toast.className = `toast toast-${type}`;
  toast.setAttribute("role", "alert");
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3500);
}
</script>
</body>
</html>
