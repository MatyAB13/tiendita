<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout — MiTienda</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="page-wrapper">

  <!-- ── NAVBAR ─────────────────────────────────────────── -->
  <nav class="navbar" role="navigation" aria-label="Navegacion principal">
    <div class="container navbar-inner">
      <a href="index.html" class="navbar-brand">MiTienda</a>
      <div class="navbar-links" id="navLinks">
        <a href="index.html">Inicio</a>
        <a href="cart.html" class="cart-link" aria-label="Carrito">
          Carrito
          <span class="cart-count" id="cartCount">0</span>
        </a>
      </div>
      <button class="hamburger" id="hamburger" aria-label="Abrir menu" aria-expanded="false" aria-controls="navLinks">
        <span></span><span></span><span></span>
      </button>
    </div>
  </nav>

  <!-- ── MAIN ──────────────────────────────────────────── -->
  <main id="main-content">
    <div class="container">

      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Ruta de navegacion">
        <a href="index.html">Inicio</a>
        <span>/</span>
        <a href="cart.html">Carrito</a>
        <span>/</span>
        <span aria-current="page">Checkout</span>
      </nav>

      <!-- Carrito vacio -->
      <div class="empty-state" id="emptyCartMsg" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
        </svg>
        <h3>Tu carrito esta vacio</h3>
        <p>Necesitas agregar productos antes de finalizar la compra.</p>
        <a href="index.html" class="btn btn-primary" style="margin-top:1rem;display:inline-flex;">Ver productos</a>
      </div>

      <!-- Confirmacion de pedido exitoso -->
      <div class="empty-state" id="successMsg" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 style="color:var(--accent);">Pedido confirmado</h3>
        <p id="successText">Tu pedido fue registrado correctamente. Te contactaremos pronto.</p>
        <a href="index.html" class="btn btn-primary" style="margin-top:1rem;display:inline-flex;">Seguir comprando</a>
      </div>

      <!-- Checkout layout -->
      <div class="checkout-layout" id="checkoutLayout" style="display:none;">

        <!-- Formulario -->
        <section aria-labelledby="formTitle">
          <h1 class="section-title" id="formTitle" style="margin-bottom:1.5rem;">Finalizar pedido</h1>

          <form id="checkoutForm" novalidate>

            <!-- Datos del cliente -->
            <div class="card" style="margin-bottom:1.25rem;">
              <h2 style="font-size:1rem;margin-bottom:1rem;">Datos de contacto</h2>

              <div class="form-group">
                <label for="clientName">Nombre completo *</label>
                <input type="text" id="clientName" name="clientName"
                       placeholder="Juan Perez" autocomplete="name" required />
                <span class="form-error" id="errClientName" role="alert"></span>
              </div>

              <div class="form-group">
                <label for="clientPhone">Telefono / WhatsApp *</label>
                <input type="tel" id="clientPhone" name="clientPhone"
                       placeholder="+54 9 11 1234-5678" autocomplete="tel" required />
                <span class="form-error" id="errClientPhone" role="alert"></span>
              </div>

              <div class="form-group">
                <label for="clientAddress">Direccion de entrega *</label>
                <textarea id="clientAddress" name="clientAddress" rows="3"
                          placeholder="Calle, numero, piso, ciudad..." autocomplete="street-address" required></textarea>
                <span class="form-error" id="errClientAddress" role="alert"></span>
              </div>
            </div>

            <!-- Metodo de pago -->
            <div class="card" style="margin-bottom:1.25rem;">
              <h2 style="font-size:1rem;margin-bottom:1rem;">Metodo de pago</h2>

              <div class="payment-options" role="radiogroup" aria-labelledby="paymentLabel">
                <label class="payment-option" id="optPix">
                  <input type="radio" name="payment" value="pix" aria-describedby="descPix" />
                  <div>
                    <div class="payment-label">Pix</div>
                    <div class="payment-desc" id="descPix">Transferencia instantanea (Brasil)</div>
                  </div>
                </label>

                <label class="payment-option" id="optMercadopago">
                  <input type="radio" name="payment" value="mercadopago" aria-describedby="descMP" />
                  <div>
                    <div class="payment-label">Mercado Pago</div>
                    <div class="payment-desc" id="descMP">Pago online seguro — Webhook disponible</div>
                  </div>
                </label>

                <label class="payment-option" id="optManual">
                  <input type="radio" name="payment" value="manual" aria-describedby="descManual" />
                  <div>
                    <div class="payment-label">Pago manual / Acuerdo</div>
                    <div class="payment-desc" id="descManual">Coordinar pago por WhatsApp o en persona</div>
                  </div>
                </label>
              </div>
              <span class="form-error" id="errPayment" role="alert" style="display:block;margin-top:.5rem;"></span>

              <!-- Info PIX dinamica -->
              <div class="pix-info" id="pixInfo" aria-live="polite">
                <p style="font-size:.82rem;margin-bottom:.5rem;color:var(--text-muted);">
                  Realiza la transferencia a la siguiente clave Pix:
                </p>
                <div class="pix-key" id="pixKey">Cargando...</div>
              </div>
            </div>

            <!-- Notas -->
            <div class="card" style="margin-bottom:1.25rem;">
              <h2 style="font-size:1rem;margin-bottom:1rem;">Notas adicionales</h2>
              <div class="form-group" style="margin:0;">
                <label for="orderNotes">Comentarios (opcional)</label>
                <textarea id="orderNotes" name="orderNotes" rows="2"
                          placeholder="Instrucciones de entrega, preferencias, etc."></textarea>
              </div>
            </div>

            <button type="submit" class="btn btn-primary btn-full" id="submitBtn"
                    style="font-size:1rem;padding:.85rem;">
              Confirmar pedido
            </button>
          </form>
        </section>

        <!-- Resumen del pedido -->
        <aside>
          <div class="cart-summary">
            <h2 style="margin-bottom:1rem;font-size:1rem;">Resumen</h2>
            <div class="order-summary-items" id="orderSummaryItems"></div>
            <div class="summary-row" style="border-top:1px solid var(--border);padding-top:.75rem;">
              <span>Subtotal</span>
              <span id="orderSubtotal">$0</span>
            </div>
            <div class="summary-row total">
              <span>Total</span>
              <span id="orderTotal">$0</span>
            </div>
          </div>
        </aside>

      </div>
    </div>
  </main>

  <!-- ── FOOTER ─────────────────────────────────────────── -->
  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <p>&copy; <span id="footerYear"></span> MiTienda. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- ── TOAST ──────────────────────────────────────────── -->
  <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>

  <!-- ── SCRIPTS ────────────────────────────────────────── -->
  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ── Helpers carrito ───────────────────────────────────
    function getCart() {
      try { return JSON.parse(localStorage.getItem("cart") || "[]"); }
      catch { return []; }
    }

    function formatPrice(n) {
      return n.toLocaleString("es-AR", { style: "currency", currency: "ARS", minimumFractionDigits: 0 });
    }

    function updateCartBadge() {
      const count = getCart().reduce((s, i) => s + i.qty, 0);
      const badge = document.getElementById("cartCount");
      if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? "flex" : "none";
      }
    }

    // ── Render resumen lateral ────────────────────────────
    function renderSummary() {
      const cart   = getCart();
      const listEl = document.getElementById("orderSummaryItems");
      let total = 0;

      listEl.innerHTML = "";
      cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        const el = document.createElement("div");
        el.className = "order-summary-item";
        el.innerHTML = `
          <img src="${item.image || "https://placehold.co/44x44?text=Producto"}"
               alt="${item.name}"
               onerror="this.src='https://placehold.co/44x44?text=Sin+imagen'" />
          <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div class="item-qty">x${item.qty}</div>
          </div>
          <div class="item-price">${formatPrice(itemTotal)}</div>
        `;
        listEl.appendChild(el);
      });

      document.getElementById("orderSubtotal").textContent = formatPrice(total);
      document.getElementById("orderTotal").textContent    = formatPrice(total);
    }

    // ── Cargar clave Pix desde settings ──────────────────
    async function loadPixKey() {
      try {
        const snap = await getDoc(doc(db, "settings", "pix"));
        if (snap.exists()) {
          document.getElementById("pixKey").textContent = snap.data().key || "No configurado";
        } else {
          document.getElementById("pixKey").textContent = "No configurado";
        }
      } catch (err) {
        console.error("[Checkout] Error cargando Pix:", err);
        document.getElementById("pixKey").textContent = "Error al cargar";
      }
    }

    // ── Metodo de pago: UI dinamica ───────────────────────
    document.querySelectorAll('input[name="payment"]').forEach(radio => {
      radio.addEventListener("change", () => {
        document.querySelectorAll(".payment-option").forEach(el => el.classList.remove("selected"));
        radio.closest(".payment-option").classList.add("selected");

        const pixInfo = document.getElementById("pixInfo");
        pixInfo.classList.toggle("visible", radio.value === "pix");

        document.getElementById("errPayment").textContent = "";
      });
    });

    // ── Validacion del formulario ─────────────────────────
    function validateForm() {
      let valid = true;

      function setError(id, msg) {
        const el = document.getElementById(id);
        if (el) { el.textContent = msg; }
        valid = false;
      }

      function clearError(id) {
        const el = document.getElementById(id);
        if (el) el.textContent = "";
      }

      const name    = document.getElementById("clientName").value.trim();
      const phone   = document.getElementById("clientPhone").value.trim();
      const address = document.getElementById("clientAddress").value.trim();
      const payment = document.querySelector('input[name="payment"]:checked');

      clearError("errClientName");
      clearError("errClientPhone");
      clearError("errClientAddress");
      clearError("errPayment");

      if (!name)    setError("errClientName",    "El nombre es obligatorio.");
      if (!phone)   setError("errClientPhone",   "El telefono es obligatorio.");
      if (!address) setError("errClientAddress", "La direccion es obligatoria.");
      if (!payment) setError("errPayment",        "Selecciona un metodo de pago.");

      return valid;
    }

    // ── Validar stock antes de confirmar ──────────────────
    async function validateStock(cart) {
      const errors = [];

      for (const item of cart) {
        try {
          const snap = await getDoc(doc(db, "products", item.id));
          if (!snap.exists()) {
            errors.push(`"${item.name}" ya no esta disponible.`);
            continue;
          }
          const currentStock = snap.data().stock ?? 0;
          if (currentStock <= 0) {
            errors.push(`"${item.name}" se agoto.`);
          } else if (item.qty > currentStock) {
            errors.push(`Solo quedan ${currentStock} unidades de "${item.name}".`);
          }
        } catch (err) {
          console.error("[Checkout] Error validando stock:", err);
          errors.push(`No se pudo verificar "${item.name}".`);
        }
      }

      return errors;
    }

    // ── Submit: crear pedido en Firestore ─────────────────
    document.getElementById("checkoutForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!validateForm()) return;

      const cart  = getCart();
      const total = cart.reduce((s, i) => s + i.price * i.qty, 0);
      const name    = document.getElementById("clientName").value.trim();
      const phone   = document.getElementById("clientPhone").value.trim();
      const address = document.getElementById("clientAddress").value.trim();
      const payment = document.querySelector('input[name="payment"]:checked').value;
      const notes   = document.getElementById("orderNotes").value.trim();

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled   = true;
      submitBtn.textContent = "Procesando...";

      try {
        // 1) Validar stock
        const stockErrors = await validateStock(cart);
        if (stockErrors.length) {
          stockErrors.forEach(msg => showToast(msg, "error"));
          submitBtn.disabled   = false;
          submitBtn.textContent = "Confirmar pedido";
          return;
        }

        // 2) Construir objeto pedido
        // Estructura preparada para webhook Mercado Pago (campo mp_preference_id)
        const pedido = {
          cliente: {
            nome:     name,
            telefone: phone,
            endereco: address,
            notas:    notes
          },
          productos: cart.map(i => ({
            id:         i.id,
            nome:       i.name,
            quantidade: i.qty,
            preco:      i.price
          })),
          total,
          metodo_pago: payment,
          estado:      "Pendente",
          data:        serverTimestamp(),
          // ── Webhook Mercado Pago (preparado para integrar) ──
          // mp_preference_id: null,
          // mp_payment_id:    null,
          // mp_status:        null,
        };

        // 3) Guardar en Firestore
        const docRef = await addDoc(collection(db, "pedidos"), pedido);

        // 4) Limpiar carrito
        localStorage.removeItem("cart");
        updateCartBadge();

        // 5) Mostrar exito
        document.getElementById("checkoutLayout").style.display = "none";
        const successMsg = document.getElementById("successMsg");
        successMsg.style.display = "block";
        document.getElementById("successText").textContent =
          `Pedido #${docRef.id.slice(0,8).toUpperCase()} registrado. Nos contactaremos en breve.`;

      } catch (err) {
        console.error("[Checkout] Error al crear pedido:", err);
        showToast("Error al procesar el pedido. Intenta nuevamente.", "error");
        submitBtn.disabled   = false;
        submitBtn.textContent = "Confirmar pedido";
      }
    });

    // ── Toast ─────────────────────────────────────────────
    function showToast(msg, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity   = "0";
        toast.style.transition = "opacity .3s";
        setTimeout(() => toast.remove(), 300);
      }, 3800);
    }

    // ── Hamburger ─────────────────────────────────────────
    const hamburger = document.getElementById("hamburger");
    const navLinks  = document.getElementById("navLinks");
    hamburger.addEventListener("click", () => {
      const open = navLinks.classList.toggle("open");
      hamburger.setAttribute("aria-expanded", open ? "true" : "false");
    });

    // ── Init ──────────────────────────────────────────────
    document.getElementById("footerYear").textContent = new Date().getFullYear();
    updateCartBadge();

    const cart = getCart();
    if (!cart.length) {
      document.getElementById("emptyCartMsg").style.display   = "block";
      document.getElementById("checkoutLayout").style.display = "none";
    } else {
      document.getElementById("emptyCartMsg").style.display   = "none";
      document.getElementById("checkoutLayout").style.display = "grid";
      renderSummary();
      loadPixKey();
    }
  </script>
</body>
</html>
