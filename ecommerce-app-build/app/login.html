<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login Admin — MiTienda</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- ── LOGIN PAGE ─────────────────────────────────────── -->
  <div class="login-page" role="main">
    <div class="login-card">

      <!-- Logo -->
      <div class="login-logo">
        <span>MiTienda</span>
        <p>Panel de administracion</p>
      </div>

      <!-- Alerta de error -->
      <div id="loginError"
           role="alert"
           aria-live="assertive"
           style="display:none;background:var(--danger-light);color:var(--danger);
                  border:1px solid var(--danger);border-radius:var(--radius-sm);
                  padding:.75rem 1rem;font-size:.875rem;margin-bottom:1rem;font-weight:500;">
      </div>

      <!-- Formulario -->
      <form id="loginForm" novalidate>

        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" name="email"
                 placeholder="admin@mitienda.com"
                 autocomplete="email"
                 required />
          <span class="form-error" id="errEmail" role="alert"></span>
        </div>

        <div class="form-group">
          <label for="loginPassword">
            Contrasena
            <button type="button" id="togglePassword"
                    aria-label="Mostrar u ocultar contrasena"
                    style="background:none;border:none;font-size:.78rem;
                           color:var(--accent);float:right;cursor:pointer;font-family:var(--font);">
              Mostrar
            </button>
          </label>
          <input type="password" id="loginPassword" name="password"
                 placeholder="••••••••"
                 autocomplete="current-password"
                 required />
          <span class="form-error" id="errPassword" role="alert"></span>
        </div>

        <button type="submit" class="btn btn-primary btn-full" id="loginBtn"
                style="margin-top:.5rem;font-size:1rem;padding:.8rem;">
          Iniciar sesion
        </button>

      </form>

      <p style="text-align:center;font-size:.8rem;color:var(--text-muted);margin-top:1.5rem;">
        Acceso restringido al equipo autorizado.
      </p>
    </div>
  </div>

  <!-- ── SCRIPTS ────────────────────────────────────────── -->
  <script type="module">
    import { auth } from "./firebase-config.js";
    import {
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ── Redirigir si ya esta autenticado ──────────────────
    onAuthStateChanged(auth, user => {
      if (user) {
        window.location.replace("dashboard.html");
      }
    });

    // ── Toggle password visibility ────────────────────────
    const passwordInput  = document.getElementById("loginPassword");
    const toggleBtn      = document.getElementById("togglePassword");
    let passwordVisible  = false;

    toggleBtn.addEventListener("click", () => {
      passwordVisible = !passwordVisible;
      passwordInput.type  = passwordVisible ? "text" : "password";
      toggleBtn.textContent = passwordVisible ? "Ocultar" : "Mostrar";
    });

    // ── Validacion local ──────────────────────────────────
    function validate() {
      let valid = true;
      const email    = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      document.getElementById("errEmail").textContent    = "";
      document.getElementById("errPassword").textContent = "";
      document.getElementById("loginError").style.display = "none";

      if (!email || !/\S+@\S+\.\S+/.test(email)) {
        document.getElementById("errEmail").textContent = "Ingresa un email valido.";
        valid = false;
      }
      if (!password || password.length < 6) {
        document.getElementById("errPassword").textContent = "La contrasena debe tener al menos 6 caracteres.";
        valid = false;
      }
      return valid;
    }

    // ── Submit ────────────────────────────────────────────
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!validate()) return;

      const email    = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      const loginBtn = document.getElementById("loginBtn");
      const errorEl  = document.getElementById("loginError");

      loginBtn.disabled   = true;
      loginBtn.textContent = "Iniciando sesion...";
      errorEl.style.display = "none";

      try {
        await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged detecta el login y redirige automaticamente
      } catch (err) {
        console.error("[Login] Error:", err.code);

        // Mensajes de error amigables
        const errorMessages = {
          "auth/user-not-found":       "No existe una cuenta con ese email.",
          "auth/wrong-password":       "Contrasena incorrecta. Intenta nuevamente.",
          "auth/invalid-email":        "El email no tiene un formato valido.",
          "auth/too-many-requests":    "Demasiados intentos. Espera un momento.",
          "auth/user-disabled":        "Esta cuenta ha sido deshabilitada.",
          "auth/invalid-credential":   "Credenciales invalidas. Verifica email y contrasena.",
          "auth/network-request-failed": "Error de red. Verifica tu conexion."
        };

        errorEl.textContent   = errorMessages[err.code] || "Error al iniciar sesion. Intenta nuevamente.";
        errorEl.style.display = "block";

        loginBtn.disabled   = false;
        loginBtn.textContent = "Iniciar sesion";
      }
    });
  </script>
</body>
</html>
