<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tienda — Mi Ecommerce</title>
  <meta name="description" content="Tienda online con los mejores productos al mejor precio." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="page-wrapper">

  <!-- ── NAVBAR ─────────────────────────────────────────── -->
  <nav class="navbar" role="navigation" aria-label="Navegacion principal">
    <div class="container navbar-inner">
      <a href="index.html" class="navbar-brand" aria-label="Inicio">MiTienda</a>

      <div class="navbar-links" id="navLinks" role="menubar">
        <a href="index.html" class="active" role="menuitem">Inicio</a>
        <a href="cart.html"  class="cart-link" role="menuitem" aria-label="Carrito">
          Carrito
          <span class="cart-count" id="cartCount" aria-live="polite">0</span>
        </a>
      </div>

      <button class="hamburger" id="hamburger" aria-label="Abrir menu" aria-expanded="false" aria-controls="navLinks">
        <span></span><span></span><span></span>
      </button>
    </div>
  </nav>

  <!-- ── HERO ──────────────────────────────────────────── -->
  <section class="hero" aria-labelledby="heroTitle">
    <div class="container">
      <h1 id="heroTitle">Los mejores productos, al mejor precio</h1>
      <p>Descubre nuestra seleccion curada con descuentos exclusivos</p>
      <a href="#productos" class="btn btn-secondary" style="border-color:#fff;color:#fff;display:inline-flex;">
        Ver productos
      </a>
    </div>
  </section>

  <!-- ── MAIN ──────────────────────────────────────────── -->
  <main id="main-content">
    <div class="container">

      <!-- Filtros de categoria -->
      <div class="filters" id="filtersContainer" role="navigation" aria-label="Filtros de categoria">
        <button class="filter-btn active" data-category="all" aria-pressed="true">Todos</button>
        <!-- Categorias dinamicas se agregan aqui -->
      </div>

      <!-- Seccion productos -->
      <section id="productos" aria-labelledby="productsTitle">
        <div class="section-header">
          <h2 class="section-title" id="productsTitle">Productos</h2>
          <span id="productsCount" style="font-size:.85rem;color:var(--text-muted);" aria-live="polite"></span>
        </div>

        <!-- Loading -->
        <div class="loading-overlay" id="loadingProducts" aria-label="Cargando productos">
          <div class="spinner" role="status">
            <span class="sr-only">Cargando...</span>
          </div>
        </div>

        <!-- Grid de productos -->
        <div class="products-grid" id="productsGrid" role="list" aria-label="Lista de productos"></div>

        <!-- Estado vacio -->
        <div class="empty-state" id="emptyState" style="display:none;" aria-live="polite">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
          </svg>
          <h3>No hay productos disponibles</h3>
          <p>Vuelve mas tarde, pronto agregaremos nuevos articulos.</p>
        </div>
      </section>
    </div>
  </main>

  <!-- ── FOOTER ─────────────────────────────────────────── -->
  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <p>&copy; <span id="footerYear"></span> MiTienda. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- ── TOAST ──────────────────────────────────────────── -->
  <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>

  <!-- ── SCRIPTS ────────────────────────────────────────── -->
  <script type="module">
    // ── Imports ───────────────────────────────────────────
    import { db } from "./firebase-config.js";
    import {
      collection,
      query,
      orderBy,
      onSnapshot,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ── Estado local ──────────────────────────────────────
    let allProducts   = [];   // todos los productos cargados
    let activeCategory = "all";

    // ── Carrito (localStorage) ────────────────────────────
    function getCart() {
      try { return JSON.parse(localStorage.getItem("cart") || "[]"); }
      catch { return []; }
    }

    function updateCartBadge() {
      const count = getCart().reduce((s, i) => s + i.qty, 0);
      const badge = document.getElementById("cartCount");
      if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? "flex" : "none";
      }
    }

    function addToCart(product) {
      if (product.stock <= 0) {
        showToast("Producto agotado", "error");
        return;
      }
      const cart  = getCart();
      const index = cart.findIndex(i => i.id === product.id);
      if (index > -1) {
        const newQty = cart[index].qty + 1;
        if (newQty > product.stock) {
          showToast("No hay suficiente stock disponible", "warning");
          return;
        }
        cart[index].qty = newQty;
      } else {
        cart.push({
          id:    product.id,
          name:  product.name,
          price: calcFinalPrice(product),
          image: product.image,
          stock: product.stock,
          qty:   1
        });
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartBadge();
      showToast(`"${product.name}" agregado al carrito`, "success");
    }

    // ── Calculo de precio con descuento ───────────────────
    function calcFinalPrice(p) {
      if (p.discount && p.discount > 0) {
        return p.price - (p.price * p.discount / 100);
      }
      return p.price;
    }

    function formatPrice(n) {
      return n.toLocaleString("es-AR", { style: "currency", currency: "ARS", minimumFractionDigits: 0 });
    }

    // ── Renderizar productos ──────────────────────────────
    function renderProducts(products) {
      const grid       = document.getElementById("productsGrid");
      const empty      = document.getElementById("emptyState");
      const countEl    = document.getElementById("productsCount");
      const loading    = document.getElementById("loadingProducts");

      loading.style.display = "none";
      grid.innerHTML = "";

      if (!products.length) {
        empty.style.display = "block";
        countEl.textContent = "";
        return;
      }
      empty.style.display = "none";
      countEl.textContent = `${products.length} producto${products.length !== 1 ? "s" : ""}`;

      products.forEach(product => {
        const finalPrice = calcFinalPrice(product);
        const isOutOfStock = product.stock <= 0;
        const hasDiscount  = product.discount && product.discount > 0;

        const card = document.createElement("article");
        card.className = "product-card";
        card.setAttribute("role", "listitem");
        card.innerHTML = `
          <a href="product.html?id=${product.id}" class="product-card-img" aria-label="Ver ${product.name}">
            <img
              src="${product.image || "https://placehold.co/400x300?text=Producto+sin+imagen"}"
              alt="${product.name}"
              loading="lazy"
              onerror="this.src='https://placehold.co/400x300?text=Imagen+no+disponible'"
            />
            <div class="badge-wrap" aria-hidden="true">
              ${isOutOfStock  ? '<span class="badge badge-out">Agotado</span>' : ""}
              ${hasDiscount   ? `<span class="badge badge-discount">-${product.discount}%</span>` : ""}
              ${product.featured && !isOutOfStock ? '<span class="badge badge-featured">Destacado</span>' : ""}
            </div>
          </a>
          <div class="product-card-body">
            <span class="product-category">${product.category || "General"}</span>
            <h3 class="product-name">${product.name}</h3>
            <div class="product-pricing">
              <span class="price-final" aria-label="Precio final: ${formatPrice(finalPrice)}">${formatPrice(finalPrice)}</span>
              ${hasDiscount ? `<span class="price-original" aria-label="Precio original: ${formatPrice(product.price)}">${formatPrice(product.price)}</span>` : ""}
            </div>
          </div>
          <div class="product-card-footer">
            <a href="product.html?id=${product.id}" class="btn btn-secondary btn-sm" style="flex:1;">Ver detalle</a>
            <button
              class="btn btn-primary btn-sm"
              style="flex:1;"
              ${isOutOfStock ? "disabled" : ""}
              data-id="${product.id}"
              aria-label="${isOutOfStock ? "Agotado" : "Agregar al carrito: " + product.name}"
            >
              ${isOutOfStock ? "Agotado" : "Agregar"}
            </button>
          </div>
        `;

        // Listener boton agregar
        const addBtn = card.querySelector("button[data-id]");
        if (addBtn && !isOutOfStock) {
          addBtn.addEventListener("click", () => addToCart(product));
        }

        grid.appendChild(card);
      });
    }

    // ── Filtros ───────────────────────────────────────────
    function buildCategoryFilters(products) {
      const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
      const container  = document.getElementById("filtersContainer");

      // Limpiar categorias dinamicas anteriores
      container.querySelectorAll("[data-category]:not([data-category='all'])").forEach(el => el.remove());

      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.className    = "filter-btn";
        btn.dataset.category = cat;
        btn.textContent  = cat;
        btn.setAttribute("aria-pressed", "false");
        btn.addEventListener("click", () => setCategory(cat));
        container.appendChild(btn);
      });
    }

    function setCategory(cat) {
      activeCategory = cat;

      // Actualizar estado visual de botones
      document.querySelectorAll(".filter-btn").forEach(btn => {
        const isActive = btn.dataset.category === cat;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-pressed", isActive ? "true" : "false");
      });

      // Filtrar productos
      const filtered = cat === "all"
        ? allProducts
        : allProducts.filter(p => p.category === cat);
      renderProducts(filtered);
    }

    // ── Cargar productos desde Firestore ──────────────────
    async function loadProducts() {
      try {
        const q = query(collection(db, "products"), orderBy("createdAt", "desc"));

        // Listener en tiempo real
        onSnapshot(q, snapshot => {
          allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          buildCategoryFilters(allProducts);
          setCategory(activeCategory);
        }, err => {
          console.error("[Tienda] Error en snapshot:", err);
          showToast("Error al cargar productos", "error");
          document.getElementById("loadingProducts").style.display = "none";
          document.getElementById("emptyState").style.display = "block";
        });
      } catch (err) {
        console.error("[Tienda] Error cargando productos:", err);
        showToast("No se pudo conectar con la base de datos", "error");
      }
    }

    // ── Toast ─────────────────────────────────────────────
    function showToast(msg, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transition = "opacity .3s";
        setTimeout(() => toast.remove(), 300);
      }, 3200);
    }

    // ── Hamburger menu ────────────────────────────────────
    const hamburger = document.getElementById("hamburger");
    const navLinks  = document.getElementById("navLinks");
    hamburger.addEventListener("click", () => {
      const open = navLinks.classList.toggle("open");
      hamburger.setAttribute("aria-expanded", open ? "true" : "false");
    });

    // ── Footer year ───────────────────────────────────────
    document.getElementById("footerYear").textContent = new Date().getFullYear();

    // ── Init ──────────────────────────────────────────────
    updateCartBadge();
    loadProducts();
  </script>
</body>
</html>
