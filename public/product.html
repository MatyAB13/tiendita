<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle de Producto — TiendaOnline</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="page-wrapper">

  <!-- ── Navbar ──────────────────────────────────────────── -->
  <nav class="navbar" role="navigation" aria-label="Navegación principal">
    <div class="navbar-inner">
      <a href="index.html" class="navbar-brand">Tienda<span>Online</span></a>
      <div class="navbar-actions">
        <button class="nav-cart-btn" onclick="window.location.href='cart.html'" aria-label="Ver carrito">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
          Carrito
          <span class="cart-count" id="cart-count">0</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- ── Main ─────────────────────────────────────────────── -->
  <main>
    <div class="container">

      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">Inicio</a>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polyline points="9 18 15 12 9 6"/></svg>
        <span id="breadcrumb-name">Cargando…</span>
      </nav>

      <!-- Contenido del producto -->
      <div id="product-content">
        <div class="loader" role="status" aria-live="polite">
          <div class="spinner" aria-hidden="true"></div>
          <p>Cargando producto…</p>
        </div>
      </div>

    </div>
  </main>

  <!-- ── Footer ────────────────────────────────────────────── -->
  <footer>
    <p>&copy; <span id="year"></span> TiendaOnline. Todos los derechos reservados.</p>
  </footer>

</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- ── Scripts ────────────────────────────────────────────── -->
<script type="module">
// ── Imports Firebase ──────────────────────────────────────
import { db } from "./firebase-config.js";
import {
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ── Año ───────────────────────────────────────────────────
document.getElementById("year").textContent = new Date().getFullYear();

// ── Estado ────────────────────────────────────────────────
let currentProduct = null;
let selectedQty    = 1;

// ── Carrito ───────────────────────────────────────────────
function getCart() {
  try { return JSON.parse(localStorage.getItem("cart")) || []; }
  catch { return []; }
}

function saveCart(cart) {
  localStorage.setItem("cart", JSON.stringify(cart));
}

function updateCartCount() {
  const total = getCart().reduce((acc, i) => acc + i.quantity, 0);
  document.getElementById("cart-count").textContent = total;
}

// ── Precio con descuento ──────────────────────────────────
function getFinalPrice(product) {
  const discount = product.discount || 0;
  return discount > 0 && discount < 100
    ? +(product.price * (1 - discount / 100)).toFixed(2)
    : product.price;
}

// ── Agregar al carrito ────────────────────────────────────
function addToCart(product, qty) {
  if (product.stock === 0) {
    showToast("Producto agotado", "error");
    return;
  }

  const cart     = getCart();
  const existing = cart.find(i => i.id === product.id);
  const qtyToAdd = qty || 1;

  if (existing) {
    const newQty = existing.quantity + qtyToAdd;
    if (newQty > product.stock) {
      showToast("Cantidad supera el stock disponible", "warning");
      return;
    }
    existing.quantity = newQty;
  } else {
    if (qtyToAdd > product.stock) {
      showToast("Cantidad supera el stock disponible", "warning");
      return;
    }
    cart.push({
      id:       product.id,
      name:     product.name,
      price:    getFinalPrice(product),
      image:    product.image || "",
      stock:    product.stock,
      quantity: qtyToAdd
    });
  }

  saveCart(cart);
  updateCartCount();
  showToast(`${qtyToAdd} unidad(es) de "${product.name}" agregada(s) al carrito`, "success");
}

// ── Renderizar detalle del producto ───────────────────────
function renderProduct(product) {
  const finalPrice   = getFinalPrice(product);
  const hasDiscount  = (product.discount || 0) > 0;
  const outOfStock   = product.stock === 0;
  const lowStock     = product.stock > 0 && product.stock <= 5;

  // Indicador de stock
  let stockBadge = "";
  if (outOfStock) {
    stockBadge = '<span class="stock-indicator stock-out">Sin stock</span>';
  } else if (lowStock) {
    stockBadge = `<span class="stock-indicator stock-low">Pocas unidades (${product.stock} disponibles)</span>`;
  } else {
    stockBadge = `<span class="stock-indicator stock-in">En stock (${product.stock} disponibles)</span>`;
  }

  // Precio con/sin descuento
  const priceHTML = hasDiscount
    ? `<span class="detail-price">$${finalPrice.toLocaleString("es")}</span>
       <span class="detail-original">$${product.price.toLocaleString("es")}</span>
       <span class="badge badge-discount">-${product.discount}%</span>`
    : `<span class="detail-price">$${product.price.toLocaleString("es")}</span>`;

  const imgSrc = product.image || "https://placehold.co/600x600?text=Producto";

  document.getElementById("product-content").innerHTML = `
    <div class="product-detail-layout">

      <!-- Imagen -->
      <div>
        <img
          class="detail-img-main"
          src="${imgSrc}"
          alt="${product.name}"
          onerror="this.src='https://placehold.co/600x600?text=Sin+imagen'"
        />
      </div>

      <!-- Info -->
      <div>
        <p class="detail-category">${product.category || "General"}</p>
        <h1 class="detail-name">${product.name}</h1>

        <div class="detail-price-row">${priceHTML}</div>

        ${stockBadge}

        <p class="detail-desc">${product.description || "Sin descripción disponible."}</p>

        <!-- Selector de cantidad -->
        <div class="form-group" style="max-width:180px; ${outOfStock ? "display:none" : ""}">
          <label class="form-label" for="qty-input">Cantidad</label>
          <div class="quantity-control">
            <button class="qty-btn" id="qty-minus" aria-label="Disminuir cantidad">-</button>
            <span class="qty-value" id="qty-display">1</span>
            <button class="qty-btn" id="qty-plus"  aria-label="Aumentar cantidad">+</button>
          </div>
        </div>

        <!-- Acciones -->
        <div style="display:flex; gap:.75rem; flex-wrap:wrap; margin-top:1.25rem;">
          <button
            class="btn btn-primary btn-lg"
            id="btn-add-cart"
            ${outOfStock ? "disabled aria-disabled='true'" : ""}
            aria-label="${outOfStock ? "Producto agotado" : "Agregar al carrito"}"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            ${outOfStock ? "Agotado" : "Agregar al carrito"}
          </button>
          <a href="cart.html" class="btn btn-secondary btn-lg">Ver carrito</a>
        </div>

        <!-- Metadatos -->
        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:.45rem;">
          <p style="font-size:.83rem; color:var(--text-muted);">
            <strong>Categoría:</strong> ${product.category || "—"}
          </p>
          <p style="font-size:.83rem; color:var(--text-muted);">
            <strong>Vendidos:</strong> ${product.sold || 0} unidades
          </p>
        </div>
      </div>
    </div>`;

  // ── Controles de cantidad ──────────────────────────────
  const minusBtn   = document.getElementById("qty-minus");
  const plusBtn    = document.getElementById("qty-plus");
  const qtyDisplay = document.getElementById("qty-display");
  const addCartBtn = document.getElementById("btn-add-cart");

  if (!outOfStock) {
    minusBtn.addEventListener("click", () => {
      if (selectedQty > 1) {
        selectedQty--;
        qtyDisplay.textContent = selectedQty;
      }
    });

    plusBtn.addEventListener("click", () => {
      if (selectedQty < product.stock) {
        selectedQty++;
        qtyDisplay.textContent = selectedQty;
      } else {
        showToast("No hay más stock disponible", "warning");
      }
    });

    addCartBtn.addEventListener("click", () => {
      addToCart(product, selectedQty);
    });
  }
}

// ── Cargar producto desde Firestore ───────────────────────
async function loadProduct() {
  const params = new URLSearchParams(window.location.search);
  const id     = params.get("id");

  if (!id) {
    document.getElementById("product-content").innerHTML = `
      <div class="empty-state" role="alert">
        <h3>Producto no encontrado</h3>
        <p><a href="index.html" class="btn btn-primary">Volver a la tienda</a></p>
      </div>`;
    return;
  }

  try {
    const docRef  = doc(db, "products", id);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      document.getElementById("product-content").innerHTML = `
        <div class="empty-state" role="alert">
          <h3>Producto no encontrado</h3>
          <p><a href="index.html" class="btn btn-primary">Volver a la tienda</a></p>
        </div>`;
      return;
    }

    currentProduct = { id: docSnap.id, ...docSnap.data() };

    // Actualizar title y breadcrumb
    document.title             = `${currentProduct.name} — TiendaOnline`;
    document.getElementById("breadcrumb-name").textContent = currentProduct.name;

    renderProduct(currentProduct);

  } catch (err) {
    console.error("[Product] Error al cargar producto:", err);
    document.getElementById("product-content").innerHTML = `
      <div class="empty-state" role="alert">
        <h3>Error al cargar el producto</h3>
        <p>Intenta nuevamente más tarde.</p>
      </div>`;
  }
}

// ── Toast ─────────────────────────────────────────────────
function showToast(message, type = "info") {
  const container = document.getElementById("toast-container");
  const toast     = document.createElement("div");
  toast.className = `toast toast-${type}`;
  toast.setAttribute("role", "alert");
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3200);
}

// ── Init ──────────────────────────────────────────────────
updateCartCount();
loadProduct();
</script>
</body>
</html>
