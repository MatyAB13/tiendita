<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultora Natura - Productos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Consultora Independiente ðŸŒ¿</h1>
        <button id="btn-cart-toggle" class="btn btn-outline">ðŸ›’ Ver Pedido</button>
    </header>

    <main class="container">
        <section id="products-section">
            <h2>Nuestros Productos</h2>
            <div id="product-list" class="product-grid">
                <!-- Productos se cargan aquÃ­ -->
            </div>
        </section>
    </main>

    <!-- Carrito Flotante -->
    <div id="cart-modal" class="cart-float">
        <div class="cart-header">
            <span>Tu Pedido</span>
            <span style="cursor:pointer" onclick="toggleCart()">âœ•</span>
        </div>
        <div id="cart-items"></div>
        <div class="cart-total">Total: R$ <span id="cart-total">0.00</span></div>
        <button onclick="sendWhatsApp()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Enviar por WhatsApp</button>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { getDocs, collection } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js';

        const productList = document.getElementById('product-list');
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const cartModal = document.getElementById('cart-modal');
        
        let cart = [];

        // Cargar productos
        async function loadProducts() {
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                productList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=Sin+Imagen'">
                        <div class="card-body">
                            <h3 class="card-title">${product.name}</h3>
                            <p class="card-price">R$ ${parseFloat(product.price).toFixed(2)}</p>
                            <button class="btn btn-primary" onclick="addToCart('${doc.id}', '${product.name}', ${product.price})">Agregar al pedido</button>
                        </div>
                    `;
                    productList.appendChild(card);
                });
            } catch (error) {
                console.error("Error cargando productos: ", error);
                productList.innerHTML = '<p style="text-align:center; width:100%">No se pudieron cargar los productos.</p>';
            }
        }

        // Funciones del Carrito
        window.addToCart = (id, name, price) => {
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ id, name, price, quantity: 1 });
            }
            updateCartUI();
            // Feedback visual simple
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Â¡Agregado!";
            setTimeout(() => btn.innerText = originalText, 1000);
        };

        window.removeFromCart = (id) => {
            cart = cart.filter(item => item.id !== id);
            updateCartUI();
        };

        function updateCartUI() {
            cartItems.innerHTML = '';
            let total = 0;

            cart.forEach(item => {
                total += item.price * item.quantity;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div>${item.name} (x${item.quantity})</div>
                    <div>
                        <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>
                        <span style="color:red; cursor:pointer; margin-left:5px;" onclick="removeFromCart('${item.id}')">âœ•</span>
                    </div>
                `;
                cartItems.appendChild(div);
            });

            cartTotal.innerText = total.toFixed(2);
        }

        window.toggleCart = () => {
            cartModal.style.display = cartModal.style.display === 'block' ? 'none' : 'block';
        };

        document.getElementById('btn-cart-toggle').addEventListener('click', toggleCart);

        window.sendWhatsApp = () => {
            if (cart.length === 0) return alert("Tu pedido estÃ¡ vacÃ­o");
            
            let message = "Hola! Me interesa realizar el siguiente pedido:%0A%0A";
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                                message += `- ${item.name} (x${item.quantity}): R$ ${itemTotal.toFixed(2)}%0A`;
                total += itemTotal;
            });
            
            message += `%0A*Total del pedido: R$ ${total.toFixed(2)}*`;
            message += `%0A%0AMi nombre es: [TU_NOMBRE]`;
            
            window.open(`https://wa.me/5548988522387?text=${message}`, '_blank');
        };

        loadProducts();
    </script>
</body>
</html>