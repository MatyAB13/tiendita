<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Consultora Natura</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Painel de Administra√ß√£o</h1>
        <button id="logout-btn" class="btn btn-outline">Sair</button>
    </header>

    <main class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('products')">üì¶ Produtos</button>
            <button class="tab-btn" onclick="switchTab('orders')">üìã Pedidos</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Configura√ß√µes</button>
        </div>

        <!-- TAB: PRODUCTOS -->
        <div id="tab-products" class="tab-content active">
            <!-- Estad√≠sticas -->
            <div class="admin-stats" id="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">Total Produtos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-offers">0</div>
                    <div class="stat-label">Em Oferta</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-soldout">0</div>
                    <div class="stat-label">Esgotados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-orders">0</div>
                    <div class="stat-label">Pedidos</div>
                </div>
            </div>

            <!-- Formulario Producto -->
            <div class="form-section">
                <h3 id="form-title">Adicionar Novo Produto</h3>
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome do Produto *</label>
                            <input type="text" id="product-name" required placeholder="Ex: Ess√™ncia de Aloe">
                        </div>
                        <div class="form-group">
                            <label>Categoria *</label>
                            <select id="product-category" required>
                                <option value="">Selecione...</option>
                                <option value="Perfumes">Perfumes</option>
                                <option value="Cremas">Cremes</option>
                                <option value="Jabones">Sabonetes</option>
                                <option value="Maquillaje">Maquiagem</option>
                                <option value="Otros">Outros</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pre√ßo (R$) *</label>
                            <input type="number" id="product-price" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Desconto (%) - Opcional</label>
                            <input type="number" id="product-discount" min="0" max="99" placeholder="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Estoque (unidades) *</label>
                            <input type="number" id="product-stock" min="0" required placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>URL da Imagem *</label>
                            <input type="url" id="product-image" required placeholder="https://...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="product-description" placeholder="Descri√ß√£o do produto..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="product-featured"> Marcar como Destaque
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar Produto</button>
                        <button type="button" id="cancel-edit" class="btn btn-outline" style="display: none;" onclick="resetForm()">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Lista Productos -->
            <div class="form-section">
                <h3>Produtos Existentes</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagem</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Pre√ßo</th>
                                <th>Estoque</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: PEDIDOS -->
        <div id="tab-orders" class="tab-content">
            <div class="form-section">
                <h3>Lista de Pedidos</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Pagamento</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: CONFIGURACIONES -->
        <div id="tab-settings" class="tab-content">
            <!-- Clave PIX -->
            <div class="form-section">
                <h3>üì± Chave PIX</h3>
                <form id="pix-form">
                    <div class="form-group">
                        <label>Chave PIX (CPF, Email, Telefone ou Chave Aleat√≥ria)</label>
                        <input type="text" id="pix-key-input" placeholder="sualoja@bancodobrasil.com.br">
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Chave PIX</button>
                </form>
            </div>

            <!-- Cartilla -->
            <div class="form-section">
                <h3>üìñ Cat√°logo/Cartilha Natura</h3>
                <p style="margin-bottom: 1rem; color: #666;">Envie o cat√°logo em PDF ou imagem</p>
                <form id="cartilla-form">
                    <div class="form-group">
                        <label>Arquivo (PDF ou Imagem)</label>
                        <input type="file" id="cartilla-file" accept=".pdf,.jpg,.jpeg,.png,.webp">
                    </div>
                    <button type="submit" class="btn btn-primary">Enviar Cat√°logo</button>
                </form>
                <div id="cartilla-preview" style="margin-top: 1rem;"></div>
            </div>

            <!-- Mercado Pago -->
            <div class="form-section">
                <h3>üí≥ Configura√ß√£o Mercado Pago</h3>
                <p style="color: #666; margin-bottom: 1rem;">
                    Configure as credenciais do Mercado Pago nas Cloud Functions.<br>
                    Vari√°veis de ambiente: MERCADO_PAGO_ACCESS_TOKEN
                </p>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth, db, storage } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js';
        import { 
            getDocs, collection, addDoc, deleteDoc, doc, updateDoc, setDoc, getDoc, query, orderBy 
        } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js';

        const form = document.getElementById('product-form');
        const tbody = document.getElementById('products-tbody');
        const ordersTbody = document.getElementById('orders-tbody');
        let isEditing = false;

        // ==================== AUTENTICACI√ìN ====================
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                loadProducts();
                loadOrders();
                loadPixKey();
                loadCartillaPreview();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = 'login.html');
        });

        // ==================== TABS ====================
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            event.target.classList.add('active');
        };

        // ==================== PRODUCTOS ====================
        async function loadProducts() {
            try {
                const q = query(collection(db, "products"), orderBy("name"));
                const snapshot = await getDocs(q);
                tbody.innerHTML = '';
                
                let totalProducts = 0;
                let totalOffers = 0;
                let totalSoldout = 0;

                snapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    totalProducts++;
                    if (p.discount > 0) totalOffers++;
                    if (p.stock == 0) totalSoldout++;

                    const price = parseFloat(p.price) || 0;
                    const discount = parseFloat(p.discount) || 0;
                    const finalPrice = discount > 0 ? price - (price * discount / 100) : price;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><img src="${p.image}" class="img-thumb" onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>${p.name}<br><small>${p.featured ? '‚≠ê Destaque' : ''}</small></td>
                        <td>${p.category || '-'}</td>
                        <td>${discount > 0 ? `<span style="text-decoration:line-through;color:#999;font-size:0.8rem">R$ ${price.toFixed(2)}</span><br>` : ''}<strong>R$ ${finalPrice.toFixed(2)}</strong></td>
                        <td><span style="color:${p.stock == 0 ? 'red' : '#333'}">${p.stock}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="editProduct('${docSnap.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${docSnap.id}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Actualizar estad√≠sticas
                document.getElementById('stat-total').innerText = totalProducts;
                document.getElementById('stat-offers').innerText = totalOffers;
                document.getElementById('stat-soldout').innerText = totalSoldout;
                
            } catch (error) {
                console.error("Error:", error);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('product-id').value;
            const productData = {
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                price: parseFloat(document.getElementById('product-price').value),
                discount: parseFloat(document.getElementById('product-discount').value) || 0,
                stock: parseInt(document.getElementById('product-stock').value),
                image: document.getElementById('product-image').value,
                description: document.getElementById('product-description').value,
                featured: document.getElementById('product-featured').checked
            };

            try {
                if (isEditing) {
                    await updateDoc(doc(db, "products", id), productData);
                } else {
                    await addDoc(collection(db, "products"), productData);
                }
                resetForm();
                loadProducts();
                alert("Produto salvo com sucesso!");
            } catch (error) {
                console.error("Error:", error);
                alert("Erro ao salvar produto");
            }
        });

        window.editProduct = async (id) => {
            try {
                const docSnap = await getDoc(doc(db, "products", id));
                if (docSnap.exists()) {
                    const p = docSnap.data();
                    document.getElementById('product-id').value = id;
                    document.getElementById('product-name').value = p.name;
                    document.getElementById('product-category').value = p.category;
                    document.getElementById('product-price').value = p.price;
                    document.getElementById('product-discount').value = p.discount || '';
                    document.getElementById('product-stock').value = p.stock;
                    document.getElementById('product-image').value = p.image;
                    document.getElementById('product-description').value = p.description || '';
                    document.getElementById('product-featured').checked = p.featured || false;
                    
                    document.getElementById('form-title').innerText = "Editar Produto";
                    document.getElementById('cancel-edit').style.display = 'inline-block';
                    isEditing = true;
                }
            } catch (error) {
                console.error("Error:", error);
            }
        };

        window.deleteProduct = async (id) => {
            if (confirm("Tem certeza que deseja excluir este produto?")) {
                try {
                    await deleteDoc(doc(db, "products", id));
                    loadProducts();
                } catch (error) {
                    console.error("Error:", error);
                }
            }
        };

        window.resetForm = () => {
            isEditing = false;
            form.reset();
            document.getElementById('product-id').value = '';
            document.getElementById('form-title').innerText = "Adicionar Novo Produto";
            document.getElementById('cancel-edit').style.display = 'none';
        };

        // ==================== PEDIDOS ====================
        async function loadOrders() {
            try {
                const q = query(collection(db, "pedidos"), orderBy("data", "desc"));
                const snapshot = await getDocs(q);
                ordersTbody.innerHTML = '';
                
                let totalOrders = 0;

                snapshot.forEach(docSnap => {
                    const order = docSnap.data();
                    totalOrders++;
                    
                    const date = order.data ? new Date(order.data).toLocaleDateString('pt-BR') : '-';
                    const statusClass = getStatusClass(order.estado);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><small>${docSnap.id}</small></td>
                        <td>${order.cliente?.nome || '-'}<br><small>${order.cliente?.telefone || '-'}</small></td>
                        <td>R$ ${(order.total || 0).toFixed(2)}</td>
                        <td>${getPaymentMethod(order.metodo_pago)}</td>
                        <td><span class="status-badge ${statusClass}">${order.estado || 'Pendente'}</span></td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="viewOrder('${docSnap.id}')">üëÅÔ∏è</button>
                            <select class="btn btn-sm" onchange="updateOrderStatus('${docSnap.id}', this.value)" style="padding: 2px 5px;">
                                <option value="">Mudar Status</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Pago">Pago</option>
                                <option value="Confirmado">Confirmado</option>
                                <option value="Enviado">Enviado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </td>
                    `;
                    ordersTbody.appendChild(tr);
                });

                document.getElementById('stat-orders').innerText = totalOrders;

            } catch (error) {
                console.error("Error:", error);
            }
        }

        function getStatusClass(status) {
            const classes = {
                'Pendente': 'status-pending',
                'Pago': 'status-paid',
                'Confirmado': 'status-confirmed',
                'Enviado': 'status-shipped',
                'Cancelado': 'status-cancelled'
            };
            return classes[status] || 'status-pending';
        }

        function getPaymentMethod(method) {
            const methods = {
                'pix': 'üì± PIX',
                'mercadopago': 'üí≥ Mercado Pago',
                'manual': 'üíµ Transfer√™ncia'
            };
            return methods[method] || method;
        }

window.viewOrder = async (id) => {
    try {
        const docSnap = await getDoc(doc(db, "pedidos", id));
        if (docSnap.exists()) {
            const order = docSnap.data();
            let details = `Pedido: ${id}\n`;
            details += `Cliente: ${order.cliente?.nome}\n`;
            details += `Telefone: ${order.cliente?.telefone}\n`;
            details += `Endere√ßo: ${order.cliente?.endereco || '-'}\n\n`;
            details += `Produtos:\n`;

            order.produtos?.forEach(p => {
                details += `- ${p.nome} (x${p.quantidade}): R$ ${(p.preco * p.quantidade).toFixed(2)}\n`;
            });

            details += `\nTotal: R$ ${order.total.toFixed(2)}\n`;
            details += `Pagamento: ${getPaymentMethod(order.metodo_pago)}\n`;
            details += `Status: ${order.estado}`;

            alert(details);
        }
    } catch (error) {
        console.error("Error:", error);
    }
};

    // ==================== PIX ====================
    document.getElementById('pix-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const key = document.getElementById('pix-key-input').value;
        try {
            await setDoc(doc(db, "settings", "pix"), { key: key });
            alert("Chave PIX salva!");
        } catch (error) {
            console.error("Error:", error);
        }
    });

    async function loadPixKey() {
        try {
            const docSnap = await getDoc(doc(db, "settings", "pix"));
            if (docSnap.exists()) {
                document.getElementById('pix-key-input').value = docSnap.data().key || '';
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }

    // ==================== CARTILLA ====================
    document.getElementById('cartilla-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('cartilla-file');
        const file = fileInput.files[0];
        
        if (!file) return alert("Selecione um arquivo");
        
        try {
            const fileType = file.type.startsWith('image/') ? 'image' : 'pdf';
            const ext = fileType === 'image' ? file.name.split('.').pop() : 'pdf';
            const storageRef = ref(storage, `cartilla/catalogo.${ext}`);
            
            const snapshot = await uploadBytes(storageRef, file);
            const url = await getDownloadURL(snapshot.ref);
            
            await setDoc(doc(db, "settings", "cartilla"), {
                url: url,
                type: fileType,
                updatedAt: new Date().toISOString()
            });
            
            alert("Cat√°logo enviado!");
            loadCartillaPreview();
        } catch (error) {
            console.error("Error:", error);
            alert("Erro ao enviar cat√°logo");
        }
    });

    async function loadCartillaPreview() {
        const container = document.getElementById('cartilla-preview');
        try {
            const docSnap = await getDoc(doc(db, "settings", "cartilla"));
            if (docSnap.exists() && docSnap.data().url) {
                const data = docSnap.data();
                if (data.type === 'image') {
                    container.innerHTML = `<img src="${data.url}" style="max-width:200px;border-radius:8px;">`;
                } else {
                    container.innerHTML = `<a href="${data.url}" target="_blank" class="btn btn-secondary">Ver PDF</a>`;
                }
            } else {
                container.innerHTML = '<p style="color:#999">Nenhum cat√°logo enviado</p>';
            }
        } catch (error) {
            container.innerHTML = '<p style="color:#999">Nenhum cat√°logo enviado</p>';
        }
    }
</script>
